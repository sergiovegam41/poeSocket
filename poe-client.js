const WebSocket=require("ws"),axios=require("axios"),fs=require("fs"),path=require("path"),http=require("http"),https=require("https"),parent_path=path.resolve(__dirname),queries_path=path.join(parent_path,"poe_graphql");let queries={};const cached_bots={},logger=console,user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36";function extractFormKey(e){let t=e.match(/<script>if\(.+\)throw new Error;(.+)<\/script>/)[1],s=t.match(/var .="([0-9a-f]+)",/)[1],a=Array.from(t.matchAll(/.\[(\d+)\]=.\[(\d+)\]/g)),n=Array(a.length).fill("");for(let i of a){let[r,o]=i.slice(1).map(Number);n[r]=s[o]}let h=n.join("");return h}function md5(){function e(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function t(t,s,a,n,i,r){var o;return e((o=e(e(s,t),e(n,r)))<<i|o>>>32-i,a)}function s(e,s,a,n,i,r,o){return t(s&a|~s&n,e,s,i,r,o)}function a(e,s,a,n,i,r,o){return t(s&n|a&~n,e,s,i,r,o)}function n(e,s,a,n,i,r,o){return t(s^a^n,e,s,i,r,o)}function i(e,s,a,n,i,r,o){return t(a^(s|~n),e,s,i,r,o)}function r(t,r){t[r>>5]|=128<<r%32,t[(r+64>>>9<<4)+14]=r;var o,h,c,_,u,l=1732584193,d=-271733879,g=-1732584194,$=271733878;for(o=0;o<t.length;o+=16)h=l,c=d,_=g,u=$,l=s(l,d,g,$,t[o],7,-680876936),$=s($,l,d,g,t[o+1],12,-389564586),g=s(g,$,l,d,t[o+2],17,606105819),d=s(d,g,$,l,t[o+3],22,-1044525330),l=s(l,d,g,$,t[o+4],7,-176418897),$=s($,l,d,g,t[o+5],12,1200080426),g=s(g,$,l,d,t[o+6],17,-1473231341),d=s(d,g,$,l,t[o+7],22,-45705983),l=s(l,d,g,$,t[o+8],7,1770035416),$=s($,l,d,g,t[o+9],12,-1958414417),g=s(g,$,l,d,t[o+10],17,-42063),d=s(d,g,$,l,t[o+11],22,-1990404162),l=s(l,d,g,$,t[o+12],7,1804603682),$=s($,l,d,g,t[o+13],12,-40341101),g=s(g,$,l,d,t[o+14],17,-1502002290),d=s(d,g,$,l,t[o+15],22,1236535329),l=a(l,d,g,$,t[o+1],5,-165796510),$=a($,l,d,g,t[o+6],9,-1069501632),g=a(g,$,l,d,t[o+11],14,643717713),d=a(d,g,$,l,t[o],20,-373897302),l=a(l,d,g,$,t[o+5],5,-701558691),$=a($,l,d,g,t[o+10],9,38016083),g=a(g,$,l,d,t[o+15],14,-660478335),d=a(d,g,$,l,t[o+4],20,-405537848),l=a(l,d,g,$,t[o+9],5,568446438),$=a($,l,d,g,t[o+14],9,-1019803690),g=a(g,$,l,d,t[o+3],14,-187363961),d=a(d,g,$,l,t[o+8],20,1163531501),l=a(l,d,g,$,t[o+13],5,-1444681467),$=a($,l,d,g,t[o+2],9,-51403784),g=a(g,$,l,d,t[o+7],14,1735328473),d=a(d,g,$,l,t[o+12],20,-1926607734),l=n(l,d,g,$,t[o+5],4,-378558),$=n($,l,d,g,t[o+8],11,-2022574463),g=n(g,$,l,d,t[o+11],16,1839030562),d=n(d,g,$,l,t[o+14],23,-35309556),l=n(l,d,g,$,t[o+1],4,-1530992060),$=n($,l,d,g,t[o+4],11,1272893353),g=n(g,$,l,d,t[o+7],16,-155497632),d=n(d,g,$,l,t[o+10],23,-1094730640),l=n(l,d,g,$,t[o+13],4,681279174),$=n($,l,d,g,t[o],11,-358537222),g=n(g,$,l,d,t[o+3],16,-722521979),d=n(d,g,$,l,t[o+6],23,76029189),l=n(l,d,g,$,t[o+9],4,-640364487),$=n($,l,d,g,t[o+12],11,-421815835),g=n(g,$,l,d,t[o+15],16,530742520),d=n(d,g,$,l,t[o+2],23,-995338651),l=i(l,d,g,$,t[o],6,-198630844),$=i($,l,d,g,t[o+7],10,1126891415),g=i(g,$,l,d,t[o+14],15,-1416354905),d=i(d,g,$,l,t[o+5],21,-57434055),l=i(l,d,g,$,t[o+12],6,1700485571),$=i($,l,d,g,t[o+3],10,-1894986606),g=i(g,$,l,d,t[o+10],15,-1051523),d=i(d,g,$,l,t[o+1],21,-2054922799),l=i(l,d,g,$,t[o+8],6,1873313359),$=i($,l,d,g,t[o+15],10,-30611744),g=i(g,$,l,d,t[o+6],15,-1560198380),d=i(d,g,$,l,t[o+13],21,1309151649),l=i(l,d,g,$,t[o+4],6,-145523070),$=i($,l,d,g,t[o+11],10,-1120210379),g=i(g,$,l,d,t[o+2],15,718787259),d=i(d,g,$,l,t[o+9],21,-343485551),l=e(l,h),d=e(d,c),g=e(g,_),$=e($,u);return[l,d,g,$]}function o(e){var t,s="",a=32*e.length;for(t=0;t<a;t+=8)s+=String.fromCharCode(e[t>>5]>>>t%32&255);return s}function h(e){var t,s=[];for(t=0,s[(e.length>>2)-1]=void 0;t<s.length;t+=1)s[t]=0;var a=8*e.length;for(t=0;t<a;t+=8)s[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return s}function c(e){var t,s,a="0123456789abcdef",n="";for(s=0;s<e.length;s+=1)n+=a.charAt((t=e.charCodeAt(s))>>>4&15)+a.charAt(15&t);return n}function _(e){return unescape(encodeURIComponent(e))}function u(e){var t;return o(r(h(t=_(e)),8*t.length))}function l(e,t){return function(e,t){var s,a,n=h(e),i=[],c=[];for(i[15]=c[15]=void 0,n.length>16&&(n=r(n,8*e.length)),s=0;s<16;s+=1)i[s]=909522486^n[s],c[s]=1549556828^n[s];return a=r(i.concat(h(t)),512+8*t.length),o(r(c.concat(a),640))}(_(e),_(t))}return function e(t,s,a){return s?a?l(s,t):c(l(s,t)):a?u(t):c(u(t))}}function load_queries(){let e=fs.readdirSync(queries_path);for(let t of e){let s=path.extname(t);if(".graphql"!==s)continue;let a=path.basename(t,s),n=fs.readFileSync(path.join(queries_path,t),"utf-8");queries[a]=n}}function generate_payload(e,t){return{query:queries[e],variables:t}}async function request_with_retries(e,t=10){for(let s=0;s<t;s++)try{let a=await e();if(200===a.status)return a;logger.warn(`Server returned a status code of ${a.status} while downloading . Retrying (${s+1}/${t})...`)}catch(n){}throw Error("Failed to download  too many times.")}class Client{gql_url="https://poe.com/api/gql_POST";gql_recv_url="https://poe.com/api/receive_POST";home_url="https://poe.com";settings_url="https://poe.com/api/settings";formkey="";next_data={};bots={};active_messages={};message_queues={};bot_names=[];ws=null;ws_connected=!1;auto_reconnect=!1;use_cached_bots=!1;constructor(e=!1,t=!1){this.auto_reconnect=e,this.use_cached_bots=t}async init(e,t=null){this.proxy=t,this.session=axios.default.create({timeout:6e4,httpAgent:new http.Agent({keepAlive:!0}),httpsAgent:new https.Agent({keepAlive:!0})}),t&&(this.session.defaults.proxy={http:t,https:t});let s=`p-b=${e}; Domain=poe.com`;this.headers={"User-Agent":user_agent,Referrer:"https://poe.com/",Origin:"https://poe.com",Cookie:s},this.session.defaults.headers.common=this.headers,this.next_data=await this.get_next_data(),this.channel=await this.get_channel_data(),this.bots=await this.get_bots(),this.bot_names=this.get_bot_names(),this.ws_domain=`tch${Math.floor(1e6*Math.random())}`,this.gql_headers={"poe-formkey":this.formkey,"poe-tchannel":this.channel.channel,...this.headers},await this.connect_ws(),await this.subscribe()}async get_next_data(){let e=await request_with_retries(()=>this.session.get(this.home_url)),t=/<script id="__NEXT_DATA__" type="application\/json">(.+?)<\/script>/.exec(e.data)[1],s=JSON.parse(t);return this.formkey=extractFormKey(e.data),this.viewer=s.props.pageProps.payload.viewer,s}async get_bots(){let e=this.next_data.props.pageProps.payload.viewer;if(!e.availableBots)throw Error("Invalid token.");let t=e.availableBots,s={};for(let a of t.filter(e=>"not_deleted"==e.deletionState)){let n=`https://poe.com/_next/data/${this.next_data.buildId}/${a.displayName}.json`,i;this.use_cached_bots&&cached_bots[n]?i=cached_bots[n]:(i=await request_with_retries(()=>this.session.get(n)),cached_bots[n]=i);let r=i.data.pageProps.payload.chatOfBotDisplayName;s[r.defaultBotObject.nickname]=r}return s}get_bot_names(){let e={};for(let t in this.bots){let s=this.bots[t].defaultBotObject;e[t]=s.displayName}return e}async get_channel_data(e=null){let t=await request_with_retries(()=>this.session.get(this.settings_url)),s=t.data;return s.tchannelData}get_websocket_url(e=null){e||(e=this.channel);let t=`?min_seq=${e.minSeq}&channel=${e.channel}&hash=${e.channelHash}`;return`wss://${this.ws_domain}.tch.${e.baseHost}/up/${e.boxName}/updates${t}`}async send_query(e,t,s){for(let a=0;a<20;a++){let n=generate_payload(e,t);s&&(n.queryName=s);let i=JSON.stringify(n),r=this.gql_headers;r["poe-tag-id"]=md5()(i+this.formkey+"WpuLMiXEKKE98j56k"),r["poe-formkey"]=this.formkey;let o=await request_with_retries(()=>this.session.post(this.gql_url,n,{headers:this.gql_headers}));if(!o.data.data){logger.warn(`${e} returned an error: ${data.errors[0].message} | Retrying (${a+1}/20)`),await new Promise(e=>setTimeout(e,2e3));continue}return o.data}throw Error(`${e} failed too many times.`)}async subscribe(){await this.send_query("SubscriptionsMutation",{subscriptions:[{subscriptionName:"messageAdded",query:queries.MessageAddedSubscription},{subscriptionName:"viewerStateUpdated",query:queries.ViewerStateUpdatedSubscription},{subscriptionName:"viewerMessageLimitUpdated",query:queries.ViewerMessageLimitUpdatedSubscription},]},"subscriptionsMutation")}ws_run_thread(){this.ws=new WebSocket(this.get_websocket_url(),{headers:{"User-Agent":user_agent},rejectUnauthorized:!1}),this.ws.on("open",()=>{this.on_ws_connect(this.ws)}),this.ws.on("message",e=>{this.on_message(this.ws,e)}),this.ws.on("close",()=>{this.ws_connected=!1}),this.ws.on("error",e=>{this.on_ws_error(this.ws,e)})}async connect_ws(){for(this.ws_connected=!1,this.ws_run_thread();!this.ws_connected;)await new Promise(e=>setTimeout(()=>{e()},10))}disconnect_ws(){this.ws&&this.ws.close(),this.ws_connected=!1}on_ws_connect(e){this.ws_connected=!0}on_ws_error(e,t){logger.warn(`Websocket returned error: ${t}`),this.disconnect_ws(),this.auto_reconnect&&this.connect_ws()}async on_message(e,t){try{let s=JSON.parse(t);if(!("messages"in s))return;for(let a of s.messages){let n=JSON.parse(a);if("subscriptionUpdate"!=n.message_type)continue;let i=n.payload.data.messageAdded;if(!i)return;let r=Object.assign({},this.active_messages);for(let[o,h]of Object.entries(r)){if(h===i.messageId&&o in this.message_queues){this.message_queues[o].push(i);return}"pending"!==o&&null===h&&"complete"!==i.state&&(this.active_messages[o]=i.messageId,this.message_queues[o].push(i))}}}catch(c){this.disconnect_ws(),await this.connect_ws()}}async *send_message(e,t,s=!1,a=20){for(console.log("Enviado mensaje..");Object.values(this.active_messages).includes(null);)await new Promise(e=>setTimeout(e,10));this.active_messages.pending=null;let n=await this.send_query("AddHumanMessageMutation",{bot:e,query:t,chatId:this.bots[e].chatId,source:null,withChatBreak:s});if(delete this.active_messages.pending,!n.data.messageCreateWithStatus.messageLimit.canSend)throw Error(`Daily limit reached for ${e}.`);let i;try{let r=n.data.messageCreateWithStatus;i=r.message.messageId}catch(o){throw Error(`An unknown error occured. Raw response data: ${n}`)}this.active_messages[i]=null,this.message_queues[i]=[];let h="",c;for(;;)try{let _=this.message_queues[i].shift();if(!_){await new Promise(e=>setTimeout(()=>e(),1e3));continue}if("complete"===_.state){if(!h||_.messageId!==c)continue;break}_.text_new=_.text.substring(h.length),h=_.text,c=_.messageId,yield _}catch(u){throw delete this.active_messages[i],delete this.message_queues[i],Error("Response timed out.")}delete this.active_messages[i],delete this.message_queues[i]}async send_chat_break(e){let t=await this.send_query("AddMessageBreakMutation",{chatId:this.bots[e].chatId});return t.data.messageBreakCreate.message}async get_message_history(e,t=25,s=null){let a=await this.send_query("ChatListPaginationQuery",{count:t,cursor:s,id:this.bots[e].id});return a.data.node.messagesConnection.edges}async delete_message(e){Array.isArray(e)||(e=[parseInt(e)]),await this.send_query("DeleteMessageMutation",{messageIds:e})}async purge_conversation(e,t=-1){let s=(await this.get_message_history(e,50)).reverse();for(;s.length;){let a=[];for(let n of s){if(0===t)break;t--,a.push(n.node.messageId)}if(await this.delete_message(a),0===t)return;s=(await this.get_message_history(e,50)).reverse()}}}load_queries(),module.exports={Client};